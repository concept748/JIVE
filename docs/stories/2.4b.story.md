# Story 2.4b: MCP Remaining Phase 1 Tools

## Status

Draft

## Story

**As an** IDE Agent (Cursor/Codex),
**I want** to invoke additional JIVE tools for task management and quality gates,
**so that** I can manage stories and view gate status from my IDE.

## Acceptance Criteria

1. **3 tools implemented:** kanban.moveStory, gates.list, runs.list
2. kanban.moveStory updates story markdown file status field (with path traversal validation)
3. gates.list returns quality gate statuses (placeholder data)
4. runs.list returns agent run history with filters (placeholder data)
5. Integration tests for all 3 tools
6. Postman collection documented for all 5 MCP tools (2 from 2.4a + 3 from 2.4b)
7. curl examples documented for all 5 tools
8. All tests pass (`pnpm test`)
9. Deployed to Railway

## Tasks / Subtasks

**Note:** Full task details available in original Story 2.4 (`docs/stories/2.4.story.md`). This story implements Tasks 5-7, 9 (complete), 11-12, 13 (complete), 14-15.

### From Original Story 2.4:

- [ ] **Task 5: Implement `kanban.moveStory` Tool** (AC: 1, 2)
  - Create `lib/mcp/tools/kanban.ts`
  - Define tool schema with scope `mcp:kanban.write`
  - Implement handler that:
    - Validates project exists
    - Finds story file based on devStoryLocation config
    - Validates lane parameter ("Backlog", "Ready", "Done")
    - **Prevents path traversal attacks** (critical security requirement)
    - Reads story markdown file
    - Updates ## Status field
    - Writes file back
  - Path validation example:

    ```typescript
    const storyPath = path.join(
      process.cwd(),
      storyLocation,
      `${story_id}.story.md`,
    );
    const resolvedPath = path.resolve(storyPath);
    const allowedDir = path.resolve(process.cwd(), storyLocation);

    if (!resolvedPath.startsWith(allowedDir)) {
      return {
        success: false,
        error: { code: 'INVALID_PATH', message: 'Path traversal detected' },
      };
    }
    ```

  - Register tool in tool-registry.ts

- [ ] **Task 6: Implement `gates.list` Tool** (AC: 1, 3)
  - Create `lib/mcp/tools/gates.ts`
  - Define tool schema with scope `mcp:gates.read`
  - Implement handler that validates project exists
  - Return empty gates array (gate table created in Epic 6)
  - Note: Placeholder data only in Epic 2
  - Register tool in tool-registry.ts

- [ ] **Task 7: Implement `runs.list` Tool** (AC: 1, 4)
  - Create `lib/mcp/tools/runs.ts`
  - Define tool schema with scope `mcp:runs.read`
  - Implement handler with filters parameter (agent, status, limit)
  - Validate project exists
  - Return empty runs array (run table created in Epic 6)
  - Note: Placeholder data only in Epic 2
  - Register tool in tool-registry.ts

- [ ] **Task 10: Write Integration Tests** (AC: 5, 8) - **COMPLETE (all 5 tools)**
  - Update `tests/integration/mcp/tools.test.ts`
  - Write test: `GET /mcp/tools returns all 5 tools`
    - Assert tools array contains status.get, conflicts.list, kanban.moveStory, gates.list, runs.list
  - Write test: `kanban.moveStory updates story status`
    - Create test story file in temp directory
    - Mock project config with devStoryLocation pointing to temp dir
    - Invoke kanban.moveStory with lane="Done"
    - Read story file
    - Assert ## Status field changed to "Done"
    - Cleanup test file
  - Write test: `kanban.moveStory prevents path traversal`
    - Invoke kanban.moveStory with story_id="../../../etc/passwd"
    - Assert returns error with INVALID_PATH code
  - Write test: `gates.list returns empty array`
    - Invoke gates.list tool
    - Assert returns { gates: [], passCount: 0, failCount: 0 }
  - Write test: `runs.list returns empty array with filters`
    - Invoke runs.list with filters: { agent: 'Dev', limit: 10 }
    - Assert returns { runs: [], count: 0 }

- [ ] **Task 11: Create Postman Collection** (AC: 6)
  - Create `docs/postman/mcp-tools.postman_collection.json`
  - Add collection with environment variables:
    - `MCP_BASE_URL`: `http://localhost:4000` or `https://jive-mcp-staging.railway.app`
    - `JWT_TOKEN`: `<generated-token>`
    - `PROJECT_ID`: `<test-project-uuid>`
  - Add requests for all 5 tools:
    1. Health Check (`GET /mcp/health`)
    2. Get Tools (`GET /mcp/tools`)
    3. Invoke status.get (`POST /mcp/invoke`)
    4. Invoke conflicts.list
    5. Invoke kanban.moveStory (with valid story_id and lane)
    6. Invoke gates.list
    7. Invoke runs.list (with filters)
  - Add pre-request script to generate JWT (using test secret)
  - Test all requests locally

- [ ] **Task 12: Create curl Examples** (AC: 7)
  - Create `docs/mcp-tools-examples.md` file
  - Document curl commands for all 5 tools:

    ```bash
    # Generate test JWT (requires web service)
    export JWT_TOKEN="<token-from-web-service>"

    # Get tools
    curl http://localhost:4000/mcp/tools \
      -H "Authorization: Bearer $JWT_TOKEN"

    # Invoke status.get
    curl -X POST http://localhost:4000/mcp/invoke \
      -H "Authorization: Bearer $JWT_TOKEN" \
      -H "Content-Type: application/json" \
      -d '{
        "tool": "status.get",
        "projectId": "<project-uuid>",
        "args": {}
      }'

    # Invoke kanban.moveStory
    curl -X POST http://localhost:4000/mcp/invoke \
      -H "Authorization: Bearer $JWT_TOKEN" \
      -H "Content-Type: application/json" \
      -d '{
        "tool": "kanban.moveStory",
        "projectId": "<project-uuid>",
        "args": {
          "story_id": "1.3",
          "lane": "Done"
        }
      }'

    # Invoke gates.list
    curl -X POST http://localhost:4000/mcp/invoke \
      -H "Authorization: Bearer $JWT_TOKEN" \
      -H "Content-Type: application/json" \
      -d '{
        "tool": "gates.list",
        "projectId": "<project-uuid>",
        "args": {}
      }'

    # Invoke runs.list with filters
    curl -X POST http://localhost:4000/mcp/invoke \
      -H "Authorization: Bearer $JWT_TOKEN" \
      -H "Content-Type: application/json" \
      -d '{
        "tool": "runs.list",
        "projectId": "<project-uuid>",
        "args": {
          "filters": {
            "agent": "Dev",
            "status": "completed",
            "limit": 10
          }
        }
      }'
    ```

  - Include expected responses for each example

- [ ] **Task 13: Update MCP Scopes** (AC: 1) - **COMPLETE**
  - Open `lib/mcp/types/jwt.ts`
  - Verify all 5 scopes defined:
    - `mcp:status.read` (Story 2.4a)
    - `mcp:conflicts.read` (Story 2.4a)
    - `mcp:kanban.write` (Story 2.4b)
    - `mcp:gates.read` (Story 2.4b)
    - `mcp:runs.read` (Story 2.4b)
  - Export scope constants

- [ ] **Task 14: Verify All Tests Pass** (AC: 8)
  - Run unit tests: `pnpm test tests/unit/mcp/`
  - Run integration tests: `pnpm test tests/integration/mcp/tools.test.ts`
  - Verify test coverage >80% for all 5 tool handlers
  - Run `pnpm type-check` to ensure no TypeScript errors
  - Run `pnpm lint` to ensure no linting errors

- [ ] **Task 15: Deploy to Railway** (AC: 9)
  - Push Story 2.4b implementation to staging branch
  - Verify Railway deployment succeeds
  - Test tool discovery: `curl https://jive-mcp-staging.railway.app/mcp/tools -H "Authorization: Bearer <token>"`
  - Test kanban.moveStory on Railway with real story file
  - Verify audit logs created in Railway Postgres for all tool invocations

## Dev Notes

### Story Split Context

This story completes the Phase 1 MCP tools:

- **Story 2.4a:** Tool infrastructure + 2 read tools (status.get, conflicts.list)
- **Story 2.4b:** 3 additional tools (1 write, 2 read) + documentation

**Key Difference:** kanban.moveStory performs file system writes (requires extra security attention)

### Previous Story Insights

**[From Story 2.4a]**

1. **Tool Registry:** ToolRegistry class exists, register() and invoke() methods implemented
2. **Tool Endpoints:** GET /mcp/tools and POST /mcp/invoke endpoints created
3. **Scope Authorization:** requireScope() integrated into /mcp/invoke endpoint
4. **Audit Logging:** logMCPAudit() called after every tool invocation

**Tools 1-2 Complete:**

- status.get: Returns agent statuses (placeholder)
- conflicts.list: Returns empty conflicts array

**Tools 3-5 To Implement (this story):**

- kanban.moveStory: **Write operation** - updates story markdown file
- gates.list: Read operation - returns gate statuses (placeholder)
- runs.list: Read operation - returns run history (placeholder)

### Architecture Context

**[Source: docs/architecture.md#kanban-tool-security]**

#### kanban.moveStory Security Requirements

**Path Traversal Prevention:**

CRITICAL: kanban.moveStory accepts user input (story_id) used to construct file path. Must prevent attacks like:

```
story_id: "../../../etc/passwd"
story_id: "..\\..\\..\\windows\\system32\\config\\sam"
```

**Security Implementation:**

```typescript
import * as path from 'path';
import * as fs from 'fs/promises';

const storyLocation = config.devStoryLocation || 'docs/stories';
const storyPath = path.join(
  process.cwd(),
  storyLocation,
  `${story_id}.story.md`,
);

// Resolve to absolute path
const resolvedPath = path.resolve(storyPath);
const allowedDir = path.resolve(process.cwd(), storyLocation);

// Ensure resolved path is within allowed directory
if (!resolvedPath.startsWith(allowedDir)) {
  return {
    success: false,
    error: {
      code: 'INVALID_STORY_PATH',
      message: 'Path traversal detected',
    },
  };
}

// Safe to proceed with file operation
const content = await fs.readFile(resolvedPath, 'utf-8');
```

**File Update Pattern:**

1. Read story file
2. Use regex to find `## Status\n\n<old-status>` pattern
3. Replace with `## Status\n\n<new-lane>`
4. Write file back atomically (write to temp → rename)

**Race Condition Note:**

Current implementation has no file locking. If multiple IDE agents move same story simultaneously, last write wins. Documented as tech debt for Phase 2.

**[Source: docs/architecture.md#placeholder-data]**

#### Placeholder Data Strategy

Tools returning placeholder data in Epic 2:

- **status.get:** Returns hardcoded agent list (idle status). Real agent statuses in Epic 3.
- **conflicts.list:** Returns empty array. Real conflicts in Epic 5.
- **gates.list:** Returns empty array. Real gates in Epic 6.
- **runs.list:** Returns empty array. Real runs in Epic 6.
- **kanban.moveStory:** Updates real story files (no placeholder - actual functionality)

### File Locations

**New Files Created in Story 2.4b:**

```
jive/
├── lib/
│   └── mcp/
│       └── tools/
│           ├── kanban.ts            # NEW - kanban.moveStory tool (file writes)
│           ├── gates.ts             # NEW - gates.list tool
│           └── runs.ts              # NEW - runs.list tool
├── docs/
│   ├── postman/
│   │   └── mcp-tools.postman_collection.json  # NEW - Postman collection
│   └── mcp-tools-examples.md        # NEW - curl examples
└── tests/integration/mcp/tools.test.ts  # UPDATE - Add tests for 3 new tools
```

**Modified Files:**

```
lib/mcp/tool-registry.ts             # UPDATE - Register 3 new tools
lib/mcp/types/jwt.ts                 # UPDATE - Add 3 new scopes
```

### Testing Strategy

**Critical Tests for kanban.moveStory:**

1. **Happy Path:** Valid story_id + valid lane → status updated
2. **Path Traversal:** story_id with "../" → INVALID_PATH error
3. **Invalid Lane:** lane not in ["Backlog", "Ready", "Done"] → INVALID_LANE error
4. **Story Not Found:** story_id doesn't exist → STORY_NOT_FOUND error
5. **File Persistence:** Verify changes written to disk

**Placeholder Tool Tests:**

- gates.list: Verify returns { gates: [], passCount: 0, failCount: 0 }
- runs.list: Verify filters parameter accepted (even if ignored in Phase 1)

### Deployment Notes

**Railway Deployment:**

- No new environment variables required
- kanban.moveStory requires write access to story files
- Railway ephemeral file system: Story files persist only if in mounted volume or git
- **Important:** Test kanban.moveStory on Railway carefully (file system behavior differs from local)

### Documentation Requirements

**Postman Collection Must Include:**

- Environment setup instructions
- JWT generation example
- All 5 tool requests with example payloads
- Expected responses for each tool

**curl Examples Must Include:**

- Token generation step
- All 5 tools with complete request examples
- Error response examples (401, 403, 404, 429)

## Change Log

| Date       | Version | Description                                                | Author |
| ---------- | ------- | ---------------------------------------------------------- | ------ |
| 2025-10-25 | 1.0     | Story split from 2.4 for 3 remaining tools + documentation | SM Bob |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent after implementation_
